// ==UserScript==
// @name         SOOP Time Recorder
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  SOOP ë¼ì´ë¸Œ í”Œë ˆì´ì–´ì—ì„œ íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡ ë° ê´€ë¦¬
// @author       result41
// @match        https://play.sooplive.co.kr/*
// @match        https://stbbs.sooplive.co.kr/vodclip/index.php/*
// @grant        GM_setValue
// @grant        GM_getValue
// @license MIT
// ==/UserScript==

(function() {
    'use strict';

    let historyWindow = null;
    const IS_CLIP_POPUP = window.location.host === 'stbbs.sooplive.co.kr';
    
    function showToast(message) {
        const existingToast = document.getElementById('soop_custom_toast');
        if (existingToast) { existingToast.remove(); }
        if (IS_CLIP_POPUP) return;
        const toast = document.createElement('div');
        toast.id = 'soop_custom_toast';
        toast.style.position = 'fixed';
        toast.style.bottom = '100px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        toast.style.color = '#fff';
        toast.style.padding = '10px 20px';
        toast.style.borderRadius = '5px';
        toast.style.zIndex = '999999';
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s ease-in-out';
        toast.style.fontSize = '14px';
        toast.innerText = message;
        document.documentElement.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '1'; }, 10);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.addEventListener('transitionend', () => {
                if (toast.parentNode) { toast.parentNode.removeChild(toast); }
            });
        }, 3000);
    }

    function extractBjIdFromPath() {
        const path = window.location.pathname;
        const pathMatch = path.match(/^\/([^\/]+)\/\d+/);
        return pathMatch && pathMatch[1] ? pathMatch[1] : null;
    }

    function extractBjIdFromUrl(url) {
        const queryMatch = url.match(/bj_id=([^&]+)/);
        return queryMatch && queryMatch[1] ? queryMatch[1] : null;
    }

    function getStorageKey(bjId) {
        return `soop_record_${bjId || 'default'}`;
    }

    function getCleanedHistory(bjId) {
        const key = getStorageKey(bjId);
        let storedData = JSON.parse(GM_getValue(key, '[]'));
        if (!Array.isArray(storedData)) { storedData = []; }
        const now = Date.now();
        const validHistory = storedData.filter(item => {
            return !item.expiry || item.expiry > now;
        });
        if (validHistory.length !== storedData.length) {
            GM_setValue(key, JSON.stringify(validHistory));
        }
        return validHistory;
    }

    function setHistory(bjId, historyArray) {
        const key = getStorageKey(bjId);
        GM_setValue(key, JSON.stringify(historyArray));
    }

    function deleteHistory() {
        if (!confirm("ì •ë§ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
        }

        const bjId = extractBjIdFromPath();
        const key = getStorageKey(bjId);

        GM_setValue(key, null);

        showToast(`âœ” ê¸°ë¡ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);

        if (historyWindow && !historyWindow.closed) {
            historyWindow.close();
            historyWindow = null;
        }
    }

    function updateMemo(id, newMemo) {
        const bjId = extractBjIdFromPath();
        const history = getCleanedHistory(bjId);
        const index = history.findIndex(item => item.id === id);
        if (index > -1) {
            history[index].memo = newMemo;
            setHistory(bjId, history);
        }
    }
    // ---------------------------------------------


    if (IS_CLIP_POPUP) {
        function waitForPopupElements() {
            const bjIdQuery = extractBjIdFromUrl(window.location.href);
            if (!bjIdQuery) return;
            let attempts = 0;
            const maxAttempts = 20;
            const interval = setInterval(() => {
                const titleElement = document.querySelector('.u_clip_title ');
                attempts++;
                if (titleElement) {
                    clearInterval(interval);
                    displayClipTimer(bjIdQuery, titleElement);
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                }
            }, 500);
        }

        function displayClipTimer(bjId, titleElement) {
            const history = getCleanedHistory(bjId);
            if (history.length === 0) return;
            const latestRecord = history[history.length - 1];
            if (!latestRecord.expiry) return;
            const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
            const savedTimeMs = latestRecord.expiry - THIRTY_DAYS_MS;
            const now = Date.now();
            const TEN_MINUTES_MS = 10 * 60 * 1000;
            const timeElapsed = now - savedTimeMs;

            if (timeElapsed < TEN_MINUTES_MS) {
                const timeLeftMs = TEN_MINUTES_MS - timeElapsed;
                const minutes = Math.floor(timeLeftMs / 60000);
                const seconds = Math.floor((timeLeftMs % 60000) / 1000);
                const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                const timerSpan = document.createElement('span');
                timerSpan.style.marginRight = '10px';
                timerSpan.style.fontWeight = 'bold';
                timerSpan.style.color = '#8e958c';
                timerSpan.innerText = `â³ ë§ˆì§€ë§‰ Record ì‹œê°„: ${timeString}`;

                titleElement.parentNode.insertBefore(timerSpan, titleElement);
            }
        }
        waitForPopupElements();
        return;
    }


    // --- ë©”ì¸ í˜ì´ì§€ ë¡œì§ (play.sooplive.co.kr) ---
    const MAX_ATTEMPTS = 40;
    let attempts = 0;

    const loadInterval = setInterval(() => {
        if (attempts >= MAX_ATTEMPTS) {
            clearInterval(loadInterval);
            console.error("SOOP Time Recorder: ë²„íŠ¼ ì‚½ì… ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í•˜ê³  ì¢…ë£Œí•©ë‹ˆë‹¤.");
            return;
        }

        // 1. ê¸°ì¡´ì˜ ì•ˆì „í•œ ìœ„ì¹˜ (#broadInfo ë‚´ #broadState ì˜†) ì‹œë„
        const broadState = document.querySelector('#broadInfo #broadState');
        if (broadState && !document.getElementById('soop_custom_buttons')) {
            clearInterval(loadInterval);
            createButtons(broadState, 'broadState'); // 1ìˆœìœ„ ì‚½ì…
            return;
        }

        // 2. ëŒ€ì²´ ìœ„ì¹˜ (#broadArea ë‚´ë¶€ ìƒë‹¨) ì‹œë„
        const broadcastArea = document.querySelector('#broadcastArea');
        if (broadcastArea && !document.getElementById('soop_custom_buttons')) {
            if (!broadState) {
                clearInterval(loadInterval);
                createButtons(broadcastArea, 'broadcastArea'); // 2ìˆœìœ„ ì‚½ì…
                return;
            }
        }

        attempts++;
    }, 500);
    // ----------------------------------------------------


    window.addEventListener('message', (event) => {
        if (!event.data || event.data.source !== 'soop_time_recorder_popup') {
            return;
        }

        const { action, value, historyUpdates } = event.data;

        switch (action) {

            case 'SAVE_ALL_MEMOS':
                if (historyUpdates && Array.isArray(historyUpdates)) {
                    const bjId = extractBjIdFromPath();
                    const currentHistory = getCleanedHistory(bjId);

                    historyUpdates.forEach(update => {
                        const index = currentHistory.findIndex(item => item.id === update.id);
                        if (index > -1) {
                            currentHistory[index].memo = update.memo;
                        }
                    });

                    setHistory(bjId, currentHistory);

                    if (value === 'COPYING') {
                        if (historyWindow && !historyWindow.closed && historyWindow.startCopy) {
                            historyWindow.startCopy();
                        }
                    }
                }
                break;
        }
    });
    // ----------------------------------------------------


    // --- ë²„íŠ¼ ë° íŒì—… ê´€ë ¨ í•¨ìˆ˜ ì •ì˜ ---
    function createButtons(targetElement, insertType) {
        const container = document.createElement('span');
        container.id = 'soop_custom_buttons';

        // ë²„íŠ¼ 3ê°œ ìƒì„±
        const btnRecord = document.createElement('button');
        btnRecord.innerText = 'Record';
        styleButton(btnRecord, '#4CAF50');
        btnRecord.onclick = recordTime;

        const btnHistory = document.createElement('button');
        btnHistory.innerText = 'History';
        styleButton(btnHistory, '#2196F3');
        btnHistory.onclick = openHistoryWindow;
        
        const btnDelete = document.createElement('button');
        btnDelete.innerText = 'Delete';
        styleButton(btnDelete, '#f44336');
        btnDelete.onclick = deleteHistory;


        if (insertType === 'broadState') {
            container.style.marginLeft = '10px';
            container.style.display = 'inline-flex';
            container.style.alignItems = 'center';
            container.style.gap = '5px';
            container.style.position = 'relative';

            container.appendChild(btnRecord);
            container.appendChild(btnHistory);
            container.appendChild(btnDelete);

            targetElement.parentNode.insertBefore(container, targetElement.nextSibling);

        } else if (insertType === 'broadcastArea') {
            container.style.display = 'block';
            container.style.position = 'absolute';
            container.style.top = '10px';
            container.style.right = '10px';
            container.style.zIndex = '10';

            const innerFlex = document.createElement('div');
            innerFlex.style.display = 'flex';
            innerFlex.style.gap = '5px';
            container.appendChild(innerFlex);

            innerFlex.appendChild(btnRecord);
            innerFlex.appendChild(btnHistory);
            innerFlex.appendChild(btnDelete);

            targetElement.appendChild(container);
        }
    }

    function recordTime() {
        const timeElement = document.querySelector('#broadInfo #time');
        if (!timeElement) {
            showToast("ì‹œê°„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const currentTime = timeElement.innerText.trim();
        if (currentTime === "00:00:00") {
            showToast("ì‹œê°„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const now = new Date();
        const timestamp = now.toLocaleTimeString();

        const bjId = extractBjIdFromPath();
        if (!bjId) {
            showToast("ë°©ì†¡ì¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const key = getStorageKey(bjId);

        const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
        const expiryTime = now.getTime() + THIRTY_DAYS_MS;

        const history = getCleanedHistory(bjId);

        history.push({
            id: Date.now().toString() + Math.random().toString(36).substring(2, 9),
            videoTime: currentTime,
            memo: "",
            savedAt: timestamp,
            expiry: expiryTime
        });

        setHistory(bjId, history);
        showToast(`âœ” íƒ€ì„ìŠ¤íƒ¬í”„ ì €ì¥ë¨: ${currentTime} `);

        if (historyWindow && !historyWindow.closed) {
             historyWindow.close();
             historyWindow = null;
             openHistoryWindow();
        }
    }

    function openHistoryWindow() {
        if (historyWindow && !historyWindow.closed) {
            historyWindow.focus();
            return;
        }

        const bjId = extractBjIdFromPath();
        if (!bjId) {
            showToast("BJ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ Historyë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const currentHistory = getCleanedHistory(bjId);
        const escapedHistoryJson = JSON.stringify(currentHistory).replace(/</g, '\\u003c');


        historyWindow = window.open('', 'SOOP_Time_History', 'width=450,height=550,scrollbars=no,resizable=yes');

        if (!historyWindow) {
            alert('íŒì—… ì°½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ ì£¼ì„¸ìš”.');
            return;
        }

        const doc = historyWindow.document;
        doc.title = 'SOOP íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡';

        doc.write(`
            <html>
            <head>
                <style>
                    html, body {
                        height: 100%; margin: 0; padding: 0; overflow: hidden;
                    }
                    body {
                        font-family: sans-serif; background-color: #2c2c2c; color: #fff; padding: 15px;
                        display: flex; flex-direction: column; box-sizing: border-box;
                    }
                    h3 {
                        color: #FFD700; border-bottom: 2px solid #555; padding-bottom: 5px; margin-top: 0;
                        flex-shrink: 0;
                    }
                    #content_area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
                    #list_container { flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 15px; }
                    ul { list-style: none; padding: 0; margin: 0; }
                    li { border-bottom: 1px solid #444; padding: 8px 0; margin-bottom: 10px; display: flex; flex-direction: column; }
                    .header-line { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
                    .video-time { font-weight: bold; color: #4CAF50; font-size: 1.2em; }
                    .memo-input {
                        width: 100%; height: 50px; padding: 5px; box-sizing: border-box; border: 1px solid #555;
                        background-color: #3a3a3a; color: white; margin-top: 5px; resize: vertical; font-family: sans-serif;
                    }
                    .saved-at { font-size: 0.8em; color: #aaa; margin-top: 2px; margin-left: 10px; }
                    .history-btn {
                        border: none; padding: 8px; border-radius: 4px; cursor: pointer;
                        font-weight: bold; width: 100%; box-sizing: border-box; flex-shrink: 0;
                        margin-bottom: 5px;
                    }
                    /* Delete ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì œê±° */
                    #copy_btn { background-color: #2196F3; color: white; }
                    #copy_btn:hover { background-color: #1976D2; }
                    .empty-message { color: #ccc; text-align: center; padding: 20px; }
                </style>
            </head>
            <body>
                <h3>SOOP íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡ (${bjId})</h3>
                <div id="content_area"></div>

                <script>
                    let historyData = JSON.parse('${escapedHistoryJson}');

                    function sendAllMemos(actionType) {
                        const memoUpdates = [];
                        const textareas = document.querySelectorAll('.memo-input');

                        textareas.forEach(textarea => {
                            const recordId = textarea.id.split('-')[2];
                            memoUpdates.push({
                                id: recordId,
                                memo: textarea.value
                            });
                            const index = historyData.findIndex(item => item.id === recordId);
                            if (index > -1) {
                                historyData[index].memo = textarea.value;
                            }
                        });

                        window.opener.postMessage({
                            source: 'soop_time_recorder_popup',
                            action: 'SAVE_ALL_MEMOS',
                            historyUpdates: memoUpdates,
                            value: actionType
                        }, '*');
                    }

                    window.onbeforeunload = function() {
                        sendAllMemos('CLOSING');
                    };

                    window.startCopy = function() {
                        copyFullHistory(true);
                    };

                    function sendMessage(action, id, value) {
                        window.opener.postMessage({
                            source: 'soop_time_recorder_popup',
                            action: action,
                            id: id,
                            value: value
                        }, '*');
                    }

                    function copyFullHistory(isSaved) {
                        if (!isSaved) {
                            sendAllMemos('COPYING');
                            return;
                        }

                        const textToCopy = historyData.slice().map(item => {
                            const baseTime = '[ ' + item.videoTime + ' ]';
                            const memoText = item.memo ? item.memo.trim() : "";
                            return memoText ? baseTime + ' - ' + memoText : baseTime;
                        }).join('\\n');

                        if (!textToCopy) {
                            alert('ë³µì‚¬í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }

                        const tempTextArea = document.createElement('textarea');
                        tempTextArea.value = textToCopy;
                        tempTextArea.style.position = 'fixed';
                        tempTextArea.style.left = '-9999px';
                        document.body.appendChild(tempTextArea);

                        try {
                            tempTextArea.select();
                            if (document.execCommand('copy')) {
                                alert('âœ” ì „ì²´ ê¸°ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\\níŒì—… ì°½ì„ ë‹«ìŠµë‹ˆë‹¤.');
                                window.close();
                            } else {
                                alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (execCommand ì‹¤íŒ¨)');
                            }
                        } catch (err) {
                            console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                            alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë³´ì•ˆ ì˜¤ë¥˜)');
                        } finally {
                            document.body.removeChild(tempTextArea);
                        }
                    }

                    document.body.addEventListener('click', function(event) {
                        const target = event.target;
                        if (target.id === 'copy_btn') {
                            copyFullHistory(false);
                        }
                    });

                    function renderHistoryContent(contentArea, historyArray) {
                        if (!contentArea) return;
                        const history = historyArray;

                        contentArea.innerHTML = '';

                        let listHTML = '<div id="list_container"><ul>';

                        if (history.length === 0) {
                            listHTML += '<p class="empty-message">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        } else {
                            [...history].reverse().forEach((item) => {
                                listHTML += \`
                                    <li id="item-\${item.id}">
                                        <div class="header-line">
                                            <span class="video-time">â° \${item.videoTime}</span>
                                            <span class="saved-at">ì €ì¥ì‹œê°: \${item.savedAt}</span>
                                        </div>
                                        <textarea
                                            id="memo-input-\${item.id}"
                                            class="memo-input"
                                            rows="2"
                                            placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                                        >\${item.memo}</textarea>
                                    </li>
                                \`;
                            });
                        }
                        listHTML += '</ul></div>';

                        const copyButtonHTML = \`<button id="copy_btn" class="history-btn">ğŸ“„ ì „ì²´ ëª©ë¡ ë³µì‚¬í•˜ê¸°</button>\`;

                        contentArea.innerHTML = listHTML + copyButtonHTML;
                    }

                    renderHistoryContent(document.getElementById('content_area'), historyData);

                </script>
            </body>
            </html>
        `);
        doc.close();
    }

    function styleButton(btn, bgColor) {
         btn.style.backgroundColor = bgColor;
         btn.style.color = 'white';
         btn.style.border = 'none';
         btn.style.padding = '4px 8px';
         btn.style.borderRadius = '3px';
         btn.style.cursor = 'pointer';
         btn.style.fontSize = '12px';
         btn.style.fontWeight = 'bold';
         btn.style.fontFamily = 'dotum, sans-serif';
    }

})();
